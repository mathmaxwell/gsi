<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <title>FaceWASM-worker</title>
  <script src="/assets/facewasm/facewasm.js"></script>
</head>

<body>
  <video id="video" playsinline loop></video>
  <canvas id="canvas"></canvas>
  <script>
    (async function () {

      const RED = '#FF124A';
      const GREEN = '#A0D3B4';
      let error = false;

      function restoreOriginalValue(percentValue, percentage) {
        return percentValue / percentage;
      }

      const handleGlobalError = (error) => {
        console.log(error);
        setTimeout(() => {
          window.location.reload();
        }, 1_000);
      };

      window.addEventListener("unhandledrejection", (error) => {
        handleGlobalError(new Error(error.reason));
      });

      window.addEventListener("error", (error) => {
        handleGlobalError(error);
      });

      const msg = (text, color) => {
        //console.log(text, color === RED ? 'RED' : color === GREEN ? 'GREEN' : color);
        if (parent) {
          parent.postMessage({ type: 'facewasm-msg', text, color });
        } else if (!error) {
          alert('window.parent unavalible');
          error = true;
        }
      };

      const cord = ({ x, y, w, h }) => {
        // console.log('x=', x, 'y=', y, 'w=', w, 'h=', h);
        if (parent) {
          parent.postMessage({
            type: 'facewasm-cord', 
            x: Math.floor(restoreOriginalValue(x, scale)),
            y: Math.floor(restoreOriginalValue(y, scale)),
            w: Math.floor(restoreOriginalValue(w, scale)),
            h: Math.floor(restoreOriginalValue(h, scale)),
          });
        } else if (!error) {
          alert('window.parent unavalible');
          error = true;
        }
      };

      let prevState = null;

      let lastStateTime = 0;

      const state = (state) => {
        // console.log('state=', state);
        {
          const now = Date.now();
          if (now - lastStateTime < 50) {
            return;
          }
          lastStateTime = now;
        }
        if (parent) {
          parent.postMessage({ type: 'facewasm-state', state });
        } else if (!error) {
          alert('window.parent unavalible');
          error = true;
        }
      };

      const createFaceDebounce = () => {
        const faces = [];
        const delta = 10;
        return (f) => {
          faces.unshift([f.x, f.y, f.w, f.h]);
          if (faces.length < delta) {
            Array.apply(null, { length: delta - 1 }).forEach(() => faces.push([f.x, f.y, f.w, f.h]));
          }
          while (faces.length > delta) {
            faces.pop();
          }
          const [x, y, w, h] = faces.reduce(([x1, y1, w1, h1], [x2, y2, w2, h2]) => [
            x1 + x2, y1 + y2, w1 + w2, h1 + h2
          ], [0, 0, 0, 0]).map((v) => v / faces.length);
          return { x, y, w, h };
        };
      };

      const { hash } = location;

      let height;
      let width;
      let scale;

      let fwUrl = '/assets/facewasm/facewasm.data';

      let noDebounce = false;

      if (hash) {
        const config = new Map(hash.substr(1).split(';').map((v) => v.split('=').map((p) => p.trim())));
        if (config.has('height')) {
          height = parseInt(config.get('height'));
        } else {
          alert('missed height');
          return;
        }
        if (config.has('width')) {
          width = parseInt(config.get('width'));
        } else {
          alert('missed width');
          return;
        }
        if (config.has('scale')) {
          scale = parseFloat(config.get('scale'));
        } else {
          alert('missed scale');
          return;
        }
        if (config.has('fwUrl')) {
          fwUrl = String(config.get('fwUrl'));
        }
        if (config.has('noDebounce')) {
          noDebounce = true;
        }
      } else {
        alert('missed hash');
        return;
      }

      const config = {
        angles: {
          yaw: 0,
          pitch: 0
        },
        qualityThreshold: 0.1,
        yawThreshold: noDebounce ? 45 : 30,
        pitchThreshold: noDebounce ? 45 : 30,
        matchTimeout: 2 * 1000,
        successDetectionRate: 0.6,
        failDetectionRate: 0.4,
        smoothBboxLength: 6,
        calcLivenessScoreInterval: 500,
        calcLivenessScoreCount: 4,
      };

      const canvas = document.getElementById('canvas');
      canvas.height = height;
      canvas.width = width;

      const context = canvas.getContext('2d', {
        willReadFrequently: true,
      });

      const initFacewasm = (res) => {
        const detector = TevianFaceWasm({
          locateFile: (path, prefix) => {
            if (path === 'facewasm.data') {
              return fwUrl;
            }
            return prefix + path;
          },
          log: (...args) => console.log(...args),
          error: (...args) => console.error(...args),
          onRuntimeInitialized: () => {
            res(detector);
          }
        });
      };

      let yaw = null;
      let pitch = null;

      const task = Object.assign({}, config);

      const fDebounce = createFaceDebounce();

      const process = (FACEWASM_DETECTOR) => {
        const { data: rgbaImage } = context.getImageData(0, 0, width, height);
        const { bbox, angles, quality } = FACEWASM_DETECTOR.detect({ height, width, rgbaImage });
        if (bbox) {
          yaw = yaw != null ? 0.8 * yaw + 0.2 * angles.yaw : angles.yaw;
          pitch = pitch != null ? 0.8 * pitch + 0.2 * angles.pitch : angles.pitch;
          if (quality < task.qualityThreshold) {
            msg('Ожидайте фокусировку камеры', RED);
            state(false);
          } else if ((task.angles != null) && (task.angles.pitch - pitch > task.pitchThreshold)) {
            msg('Поверните голову наверх', RED);
            state(false);
          } else if ((task.angles != null) && (pitch - task.angles.pitch > task.pitchThreshold)) {
            msg('Поверните голову вниз', RED);
            state(false);
          } else if ((task.angles != null) && (task.angles.yaw - yaw > task.yawThreshold)) {
            msg('Поверните голову налево', RED);
            state(false);
          } else if ((task.angles != null) && (yaw - task.angles.yaw > task.yawThreshold)) {
            msg('Поверните голову направо', RED);
            state(false);
          } else {
            msg('Замрите', GREEN);
            state(true);
            color = GREEN;
          }
          const { x, y, w, h } = bbox;
          cord(noDebounce ? { x, y, w, h } : fDebounce({ x, y, w, h }));
        } else {
          msg('Подвинтесь в центр камеры', RED);
          state(false);
        }
      };

      setTimeout(() => initFacewasm((f) => {

        window.addEventListener("message", (event) => {
          if (event.data.type === "bitmap") {
            const bitmap = event.data.frame;
            context.clearRect(0, 0, width, height);
            context.drawImage(bitmap, 0, 0, width, height);
            bitmap.close();
            process(f);
          }
        });

        state(false);

      }));

    })();
  </script>
</body>

</html>
